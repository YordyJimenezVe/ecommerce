<div class="send-notif-page">

    <div class="page-header">
        <div>
            <h1>üì¢ Enviar Notificaciones</h1>
            <p>{{ isAdmin ? 'Env√≠a notificaciones a empresas, usuarios o tu equipo' : 'Env√≠a mensajes a tu equipo' }}
            </p>
        </div>
        <button class="btn-history" (click)="showHistory = !showHistory">
            <i class="fas fa-history"></i> {{ showHistory ? 'Ocultar' : 'Ver' }} Historial
        </button>
    </div>

    <div class="send-layout">

        <!-- Send Form -->
        <div class="send-card">
            <h3>‚úâÔ∏è Nueva Notificaci√≥n</h3>

            <!-- Target type -->
            <div class="form-group">
                <label>Destinatarios</label>
                <div class="target-options">
                    <button *ngFor="let t of targetOptions" class="target-btn"
                        [class.active]="form.target_type === t.value" (click)="selectTarget(t.value)">
                        {{ t.icon }} {{ t.label }}
                    </button>
                </div>
            </div>

            <!-- Company selector (super admin only) -->
            <div class="form-group" *ngIf="form.target_type === 'company' && isAdmin">
                <label>Seleccionar Empresas</label>
                <div class="search-input-wrap">
                    <input type="text" [(ngModel)]="companySearch" placeholder="Buscar empresa..."
                        class="form-control small">
                </div>
                <div class="select-list">
                    <label *ngFor="let c of filteredCompanies" class="select-item">
                        <input type="checkbox" [value]="c.id" (change)="toggleId(c.id, 'companies')">
                        <span>{{ c.name }}</span>
                    </label>
                    <span *ngIf="!targets.companies?.length" class="no-data">Cargando empresas...</span>
                </div>
            </div>

            <!-- User selector (staff when target = user or company_staff) -->
            <div class="form-group" *ngIf="form.target_type === 'user' || form.target_type === 'company_staff'">
                <label>
                    {{ isAdmin && form.target_type === 'user' ? 'Seleccionar Usuarios Administradores' : 'Seleccionar
                    Miembros del Equipo' }}
                    <span class="optional">(vac√≠o = todos)</span>
                </label>
                <div class="search-input-wrap">
                    <input type="text" [(ngModel)]="staffSearch" placeholder="Buscar..." class="form-control small">
                </div>
                <div class="select-list">
                    <label *ngFor="let u of filteredStaff" class="select-item">
                        <input type="checkbox" [value]="u.id" (change)="toggleId(u.id, 'staff')">
                        <span>{{ u.name }} {{ u.surname }} <em>{{ u.email }}</em></span>
                    </label>
                    <span *ngIf="!targets.staff?.length" class="no-data">Cargando usuarios...</span>
                </div>
            </div>

            <!-- Type/icon picker -->
            <div class="two-col-sm">
                <div class="form-group">
                    <label>Tipo</label>
                    <div class="type-buttons">
                        <button *ngFor="let t of notifTypes" class="type-btn" [class.active]="form.type === t.value"
                            [style.border-color]="form.type === t.value ? t.color : ''"
                            [style.color]="form.type === t.value ? t.color : ''" (click)="selectType(t)">
                            {{ t.icon }} {{ t.label }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div class="form-group">
                <label>T√≠tulo *</label>
                <input type="text" [(ngModel)]="form.title" class="form-control"
                    placeholder="Ej: Mantenimiento programado">
            </div>

            <!-- Message -->
            <div class="form-group">
                <label>Mensaje *</label>
                <textarea [(ngModel)]="form.message" rows="4" class="form-control"
                    placeholder="Escribe el mensaje detallado..."></textarea>
            </div>

            <!-- Link (optional) -->
            <div class="form-group">
                <label>Enlace <span class="optional">(opcional)</span></label>
                <input type="text" [(ngModel)]="form.link" class="form-control" placeholder="Ej: /support o /billing">
            </div>

            <!-- Preview -->
            <div class="preview-card" *ngIf="form.title || form.message">
                <div class="preview-label">Vista previa</div>
                <div class="preview-notif">
                    <div class="preview-icon" [style.background]="form.color">
                        <i [class]="form.icon"></i>
                    </div>
                    <div class="preview-text">
                        <div class="preview-title">{{ form.title || 'T√≠tulo' }}</div>
                        <div class="preview-msg">{{ form.message || 'Mensaje...' }}</div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn-reset" (click)="resetForm()">Limpiar</button>
                <button class="btn-send" (click)="send()" [disabled]="sending || !form.title || !form.message">
                    <i class="fas fa-paper-plane"></i>
                    {{ sending ? 'Enviando...' : 'Enviar Notificaci√≥n' }}
                </button>
            </div>

            <!-- Result message -->
            <div class="success-msg" *ngIf="successMsg">‚úÖ {{ successMsg }}</div>
            <div class="error-msg" *ngIf="errorMsg">‚ùå {{ errorMsg }}</div>
        </div>

        <!-- History panel -->
        <div class="history-card" *ngIf="showHistory">
            <h3>üìã Historial de Env√≠os</h3>
            <div class="mini-spinner" *ngIf="historyLoading"></div>
            <div class="history-list" *ngIf="!historyLoading">
                <div class="history-item" *ngFor="let h of history">
                    <div class="history-icon">üì¢</div>
                    <div class="history-body">
                        <strong>{{ h.title }}</strong>
                        <span>{{ h.message }}</span>
                        <div class="history-meta">
                            <em>{{ h.recipients }} destinatario(s)</em>
                            <span>{{ h.created_at | date:'dd/MM HH:mm' }}</span>
                        </div>
                    </div>
                </div>
                <div class="no-data" *ngIf="!history?.length">Sin env√≠os recientes</div>
            </div>
        </div>

    </div>
</div>